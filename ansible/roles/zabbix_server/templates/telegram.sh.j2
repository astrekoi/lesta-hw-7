# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ Ansible - –ù–ï –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –í–†–£–ß–ù–£–Æ!

#!/bin/bash

TELEGRAM_BOT_TOKEN="{{ telegram_bot_token }}"
CHAT_ID="{{ telegram_chat_id }}"
USER_SURNAME="{{ user_surname }}"

SENDTO="$1"
SUBJECT="$2"
MESSAGE="$3"

if [ -z "$SENDTO" ] || [ -z "$SUBJECT" ] || [ -z "$MESSAGE" ]; then
    echo "–û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞–Ω—ã"
    exit 1
fi

LOG_FILE="/var/log/zabbix/telegram.log"
if [ ! -f "$LOG_FILE" ]; then
    sudo mkdir -p /var/log/zabbix 2>/dev/null || true
    sudo touch "$LOG_FILE" 2>/dev/null || true
    sudo chown zabbix:zabbix "$LOG_FILE" 2>/dev/null || true
    sudo chmod 664 "$LOG_FILE" 2>/dev/null || true
fi

safe_log() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $message" >> "$LOG_FILE" 2>/dev/null
}

escape_markdown() {
    echo "$1" | sed 's/[_*\[`]/\\&/g'
}

ESCAPED_SUBJECT=$(escape_markdown "$SUBJECT")
ESCAPED_MESSAGE=$(escape_markdown "$MESSAGE")

FULL_MESSAGE="üö® *Zabbix Alert –æ—Ç ${USER_SURNAME}*

*–¢–µ–º–∞:* ${ESCAPED_SUBJECT}

*–°–æ–æ–±—â–µ–Ω–∏–µ:*
${ESCAPED_MESSAGE}

*–í—Ä–µ–º—è:* $(date '+%Y-%m-%d %H:%M:%S')
*–°–µ—Ä–≤–µ—Ä:* $(hostname)"

send_telegram() {
    local max_retries=3
    local retry_count=0
    
    safe_log "–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç ${USER_SURNAME}"
    
    while [ $retry_count -lt $max_retries ]; do
        retry_count=$((retry_count + 1))
        
        response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${SENDTO}" \
            -d "text=${FULL_MESSAGE}" \
            -d "parse_mode=Markdown" \
            --connect-timeout 10 \
            --max-time 30 2>&1)
        
        http_code=$(echo "$response" | tail -n1 | sed 's/.*HTTP_CODE://')
        response_body=$(echo "$response" | sed '$d')
        
        if [ "$http_code" = "200" ] && echo "$response_body" | grep -q '"ok":true'; then
            safe_log "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
            echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ –≤ Telegram"
            exit 0
        else
            if [ "$http_code" = "400" ]; then
                safe_log "–û—à–∏–±–∫–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞"
            elif [ "$http_code" = "401" ] || [ "$http_code" = "403" ]; then
                safe_log "–û—à–∏–±–∫–∞: –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–æ–º –∏–ª–∏ –¥–æ—Å—Ç—É–ø–æ–º"
            elif [ "$http_code" = "404" ]; then
                safe_log "–û—à–∏–±–∫–∞: —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            elif [ -z "$http_code" ]; then
                safe_log "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞"
            else
                safe_log "HTTP –æ—à–∏–±–∫–∞ $http_code"
            fi
            
            if [ $retry_count -lt $max_retries ]; then
                echo "–ü–æ–ø—ã—Ç–∫–∞ $retry_count –∏–∑ $max_retries –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."
                sleep 5
            fi
        fi
    done
    
    safe_log "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ $max_retries –ø–æ–ø—ã—Ç–æ–∫"
    echo "–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –ø–æ—Å–ª–µ $max_retries –ø–æ–ø—ã—Ç–æ–∫"
    exit 1
}

check_api() {
    api_check=$(curl -s --connect-timeout 5 "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe" 2>&1)
    
    if ! echo "$api_check" | grep -q '"ok":true'; then
        safe_log "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Telegram API"
        echo "–û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Telegram API"
        exit 1
    fi
}

main() {
    safe_log "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
    check_api
    send_telegram
}

main "$@"
